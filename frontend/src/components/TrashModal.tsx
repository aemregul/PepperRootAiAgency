"use client";

import { useState } from "react";
import { X, Trash2, RotateCcw, Clock, AlertCircle, CheckSquare, Square, Trash, ImageIcon, Video } from "lucide-react";

export interface TrashItem {
    id: string;
    name: string;
    type: "proje" | "karakter" | "lokasyon" | "wardrobe" | "plugin" | "marka" | "session" | "character" | "location" | "brand" | "asset";
    deletedAt: Date;
    imageUrl?: string;
    originalData: any;
}

interface TrashModalProps {
    isOpen: boolean;
    onClose: () => void;
    items: TrashItem[];
    onRestore: (item: TrashItem) => void;
    onPermanentDelete: (id: string) => void;
    onDeleteAll?: () => void;
    onDeleteMultiple?: (ids: string[]) => void;
}

function getTimeRemaining(deletedAt: Date): string {
    const now = new Date();
    const deleteTime = new Date(deletedAt);
    deleteTime.setDate(deleteTime.getDate() + 3); // 3 gün sonra silinecek

    const diff = deleteTime.getTime() - now.getTime();
    if (diff <= 0) return "Siliniyor...";

    const hours = Math.floor(diff / (1000 * 60 * 60));
    const days = Math.floor(hours / 24);
    const remainingHours = hours % 24;

    if (days > 0) {
        return `${days} gün ${remainingHours} saat`;
    }
    return `${hours} saat`;
}

function getTypeLabel(type: TrashItem["type"]): string {
    const labels: Record<TrashItem["type"], string> = {
        proje: "Proje",
        session: "Proje",
        karakter: "Karakter",
        character: "Karakter",
        lokasyon: "Lokasyon",
        location: "Lokasyon",
        wardrobe: "Kıyafet",
        plugin: "Plugin",
        marka: "Marka",
        brand: "Marka",
        asset: "Asset"
    };
    return labels[type] || type;
}

function getTypeColor(type: TrashItem["type"]): string {
    const colors: Record<TrashItem["type"], string> = {
        proje: "#22c55e",
        session: "#22c55e",
        karakter: "#8b5cf6",
        character: "#8b5cf6",
        lokasyon: "#3b82f6",
        location: "#3b82f6",
        wardrobe: "#f59e0b",
        plugin: "#ec4899",
        marka: "#06b6d4",
        brand: "#06b6d4",
        asset: "#f97316"
    };
    return colors[type] || "#6b7280";
}

export function TrashModal({
    isOpen,
    onClose,
    items,
    onRestore,
    onPermanentDelete,
    onDeleteAll,
    onDeleteMultiple
}: TrashModalProps) {
    const [confirmDelete, setConfirmDelete] = useState<string | null>(null);
    const [selectedIds, setSelectedIds] = useState<string[]>([]);
    const [confirmDeleteAll, setConfirmDeleteAll] = useState(false);
    const [confirmDeleteSelected, setConfirmDeleteSelected] = useState(false);
    const [activeFilter, setActiveFilter] = useState<TrashItem["type"] | "all">("all");

    if (!isOpen) return null;

    // Filtreleme
    const filteredItems = activeFilter === "all"
        ? items
        : items.filter(item => item.type === activeFilter);

    // Kategori sayıları
    const categoryCounts = {
        all: items.length,
        proje: items.filter(i => i.type === "proje" || i.type === "session").length,
        karakter: items.filter(i => i.type === "karakter" || i.type === "character").length,
        lokasyon: items.filter(i => i.type === "lokasyon" || i.type === "location").length,
        wardrobe: items.filter(i => i.type === "wardrobe").length,
        asset: items.filter(i => i.type === "asset").length,
        plugin: items.filter(i => i.type === "plugin").length,
        marka: items.filter(i => i.type === "marka" || i.type === "brand").length,
    };

    const toggleSelection = (id: string) => {
        if (selectedIds.includes(id)) {
            setSelectedIds(selectedIds.filter(i => i !== id));
        } else {
            setSelectedIds([...selectedIds, id]);
        }
    };

    const toggleSelectAll = () => {
        if (selectedIds.length === filteredItems.length) {
            setSelectedIds([]);
        } else {
            setSelectedIds(filteredItems.map(i => i.id));
        }
    };

    const handleDeleteSelected = () => {
        if (onDeleteMultiple) {
            onDeleteMultiple(selectedIds);
        } else {
            selectedIds.forEach(id => onPermanentDelete(id));
        }
        setSelectedIds([]);
        setConfirmDeleteSelected(false);
    };

    const handleDeleteAll = () => {
        if (onDeleteAll) {
            onDeleteAll();
        } else {
            items.forEach(item => onPermanentDelete(item.id));
        }
        setConfirmDeleteAll(false);
    };

    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
            {/* Backdrop */}
            <div
                className="absolute inset-0 bg-black/70 backdrop-blur-md"
                onClick={onClose}
            />

            {/* Modal */}
            <div
                className="relative w-full max-w-lg max-h-[80vh] rounded-2xl shadow-2xl overflow-hidden"
                style={{ background: "var(--card)", border: "1px solid var(--border)" }}
            >
                {/* Header */}
                <div
                    className="flex items-center justify-between p-5 border-b"
                    style={{
                        borderColor: "var(--border)",
                        background: "linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, transparent 100%)"
                    }}
                >
                    <div className="flex items-center gap-3">
                        <div
                            className="p-2 rounded-xl"
                            style={{ background: "rgba(239, 68, 68, 0.2)" }}
                        >
                            <Trash2 size={24} className="text-red-500" />
                        </div>
                        <div>
                            <h2 className="text-xl font-bold">Çöp Kutusu</h2>
                            <p className="text-xs" style={{ color: "var(--foreground-muted)" }}>
                                {items.length} öğe • 3 gün sonra kalıcı silinir
                            </p>
                        </div>
                    </div>
                    <button
                        onClick={onClose}
                        className="p-2 rounded-xl hover:bg-[var(--background)] transition-all duration-200"
                    >
                        <X size={20} />
                    </button>
                </div>

                {/* Category Tabs */}
                {items.length > 0 && (
                    <div
                        className="flex gap-2 px-4 py-3 overflow-x-auto border-b"
                        style={{ borderColor: "var(--border)", background: "var(--background)" }}
                    >
                        {[
                            { key: "all" as const, label: "Tümü", color: "#6b7280" },
                            { key: "asset" as const, label: "Görseller", color: "#f97316" },
                            { key: "proje" as const, label: "Projeler", color: "#22c55e" },
                            { key: "karakter" as const, label: "Karakterler", color: "#8b5cf6" },
                            { key: "lokasyon" as const, label: "Lokasyonlar", color: "#3b82f6" },
                            { key: "wardrobe" as const, label: "Kıyafetler", color: "#f59e0b" },
                            { key: "plugin" as const, label: "Pluginler", color: "#ec4899" },
                            { key: "marka" as const, label: "Markalar", color: "#06b6d4" },
                        ].map(cat => {
                            const count = categoryCounts[cat.key];
                            if (cat.key !== "all" && count === 0) return null;
                            return (
                                <button
                                    key={cat.key}
                                    onClick={() => {
                                        setActiveFilter(cat.key);
                                        setSelectedIds([]);
                                    }}
                                    className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm whitespace-nowrap transition-all ${activeFilter === cat.key
                                        ? "ring-2 ring-offset-1 ring-offset-transparent"
                                        : "opacity-70 hover:opacity-100"
                                        }`}
                                    style={{
                                        background: activeFilter === cat.key ? `${cat.color}20` : "var(--card)",
                                        color: activeFilter === cat.key ? cat.color : "inherit",
                                        borderColor: activeFilter === cat.key ? cat.color : "transparent",
                                        borderWidth: "2px"
                                    }}
                                >
                                    <span
                                        className="w-2 h-2 rounded-full"
                                        style={{ background: cat.color }}
                                    />
                                    {cat.label}
                                    <span
                                        className="px-1.5 py-0.5 rounded text-xs"
                                        style={{ background: "var(--background)" }}
                                    >
                                        {count}
                                    </span>
                                </button>
                            );
                        })}
                    </div>
                )}

                {/* Toolbar - Select All & Bulk Actions */}
                {items.length > 0 && (
                    <div
                        className="flex items-center justify-between px-4 py-2 border-b"
                        style={{ borderColor: "var(--border)", background: "var(--background)" }}
                    >
                        <button
                            onClick={toggleSelectAll}
                            className="flex items-center gap-2 text-sm hover:opacity-80 transition-opacity"
                        >
                            {selectedIds.length === items.length ? (
                                <CheckSquare size={18} style={{ color: "var(--accent)" }} />
                            ) : (
                                <Square size={18} style={{ color: "var(--foreground-muted)" }} />
                            )}
                            <span style={{ color: "var(--foreground-muted)" }}>
                                {selectedIds.length > 0 ? `${selectedIds.length} seçili` : "Tümünü Seç"}
                            </span>
                        </button>

                        <div className="flex items-center gap-2">
                            {/* Delete Selected */}
                            {selectedIds.length > 0 && (
                                confirmDeleteSelected ? (
                                    <div className="flex items-center gap-1">
                                        <button
                                            onClick={handleDeleteSelected}
                                            className="px-3 py-1.5 text-xs rounded-lg bg-red-500 text-white hover:bg-red-600 transition-colors"
                                        >
                                            {selectedIds.length} Öğeyi Sil
                                        </button>
                                        <button
                                            onClick={() => setConfirmDeleteSelected(false)}
                                            className="px-3 py-1.5 text-xs rounded-lg hover:bg-[var(--card)] transition-colors"
                                        >
                                            İptal
                                        </button>
                                    </div>
                                ) : (
                                    <button
                                        onClick={() => setConfirmDeleteSelected(true)}
                                        className="flex items-center gap-1 px-3 py-1.5 text-xs rounded-lg hover:bg-red-500/20 text-red-400 transition-colors"
                                    >
                                        <Trash size={14} />
                                        Seçilenleri Sil
                                    </button>
                                )
                            )}

                            {/* Delete All */}
                            {confirmDeleteAll ? (
                                <div className="flex items-center gap-1">
                                    <button
                                        onClick={handleDeleteAll}
                                        className="px-3 py-1.5 text-xs rounded-lg bg-red-500 text-white hover:bg-red-600 transition-colors"
                                    >
                                        Tümünü Sil
                                    </button>
                                    <button
                                        onClick={() => setConfirmDeleteAll(false)}
                                        className="px-3 py-1.5 text-xs rounded-lg hover:bg-[var(--card)] transition-colors"
                                    >
                                        İptal
                                    </button>
                                </div>
                            ) : (
                                <button
                                    onClick={() => setConfirmDeleteAll(true)}
                                    className="flex items-center gap-1 px-3 py-1.5 text-xs rounded-lg border border-red-500/50 text-red-400 hover:bg-red-500/20 transition-colors"
                                >
                                    <Trash2 size={14} />
                                    Tümünü Sil
                                </button>
                            )}
                        </div>
                    </div>
                )}

                {/* Content */}
                <div className="p-4 overflow-y-auto max-h-[calc(80vh-180px)]">
                    {items.length === 0 ? (
                        <div className="text-center py-12">
                            <Trash2 size={48} className="mx-auto mb-3 opacity-20" />
                            <p style={{ color: "var(--foreground-muted)" }}>
                                Çöp kutusu boş
                            </p>
                        </div>
                    ) : (
                        <div className="space-y-2">
                            {filteredItems.map((item) => (
                                <div
                                    key={item.id}
                                    className={`flex items-center justify-between p-3 rounded-xl transition-all ${selectedIds.includes(item.id) ? "ring-2 ring-[var(--accent)]" : ""
                                        }`}
                                    style={{ background: "var(--background)" }}
                                >
                                    {/* Checkbox */}
                                    <button
                                        onClick={() => toggleSelection(item.id)}
                                        className="mr-3 shrink-0"
                                    >
                                        {selectedIds.includes(item.id) ? (
                                            <CheckSquare size={20} style={{ color: "var(--accent)" }} />
                                        ) : (
                                            <Square size={20} style={{ color: "var(--foreground-muted)" }} />
                                        )}
                                    </button>

                                    <div className="flex items-center gap-3 flex-1 min-w-0">
                                        {/* Thumbnail for assets */}
                                        {item.imageUrl ? (
                                            <div className="w-14 h-14 rounded-lg overflow-hidden shrink-0 border border-[var(--border)]">
                                                {item.imageUrl.match(/\.(mp4|mov|webm)(\?.*)?$/i) ? (
                                                    <div className="w-full h-full flex items-center justify-center bg-[var(--card)]">
                                                        <Video size={24} style={{ color: getTypeColor(item.type) }} />
                                                    </div>
                                                ) : (
                                                    <img
                                                        src={item.imageUrl}
                                                        alt={item.name}
                                                        className="w-full h-full object-cover"
                                                        onError={(e) => {
                                                            (e.target as HTMLImageElement).style.display = 'none';
                                                            (e.target as HTMLImageElement).parentElement!.innerHTML = '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:var(--card)"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg></div>';
                                                        }}
                                                    />
                                                )}
                                            </div>
                                        ) : (
                                            <div
                                                className="w-2 h-2 rounded-full shrink-0"
                                                style={{ background: getTypeColor(item.type) }}
                                            />
                                        )}
                                        <div className="flex-1 min-w-0">
                                            <div className="font-medium truncate text-sm">
                                                {item.imageUrl ? (item.name.length > 40 ? item.name.slice(0, 40) + '…' : item.name) : item.name}
                                            </div>
                                            <div className="flex items-center gap-2 text-xs" style={{ color: "var(--foreground-muted)" }}>
                                                <span
                                                    className="px-1.5 py-0.5 rounded"
                                                    style={{ background: "var(--card)" }}
                                                >
                                                    {getTypeLabel(item.type)}
                                                </span>
                                                <span className="flex items-center gap-1">
                                                    <Clock size={10} />
                                                    {getTimeRemaining(item.deletedAt)}
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="flex items-center gap-1 shrink-0">
                                        {/* Restore button */}
                                        <button
                                            onClick={() => onRestore(item)}
                                            className="p-2 rounded-lg hover:bg-green-500/20 transition-colors"
                                            title="Geri Yükle"
                                        >
                                            <RotateCcw size={16} className="text-green-500" />
                                        </button>

                                        {/* Permanent delete button */}
                                        {confirmDelete === item.id ? (
                                            <div className="flex items-center gap-1">
                                                <button
                                                    onClick={() => {
                                                        onPermanentDelete(item.id);
                                                        setConfirmDelete(null);
                                                    }}
                                                    className="px-2 py-1 text-xs rounded bg-red-500 text-white hover:bg-red-600 transition-colors"
                                                >
                                                    Sil
                                                </button>
                                                <button
                                                    onClick={() => setConfirmDelete(null)}
                                                    className="px-2 py-1 text-xs rounded hover:bg-[var(--card)] transition-colors"
                                                >
                                                    İptal
                                                </button>
                                            </div>
                                        ) : (
                                            <button
                                                onClick={() => setConfirmDelete(item.id)}
                                                className="p-2 rounded-lg hover:bg-red-500/20 transition-colors"
                                                title="Kalıcı Sil"
                                            >
                                                <Trash2 size={16} className="text-red-400" />
                                            </button>
                                        )}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>

                {/* Footer info */}
                {items.length > 0 && (
                    <div
                        className="px-4 py-3 border-t flex items-center gap-2 text-xs"
                        style={{ borderColor: "var(--border)", color: "var(--foreground-muted)" }}
                    >
                        <AlertCircle size={14} />
                        <span>Öğeler 3 gün sonra otomatik olarak kalıcı silinir.</span>
                    </div>
                )}
            </div>
        </div>
    );
}
